# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: Performance Benchmarks

on:
  push:
    branches:
      - main
      - feature/benchmark-suite  # For testing - remove before merging
    paths:
      - '.github/workflows/benchmarks.yml'
      - 'csharp/src/**'
      - 'csharp/Benchmarks/**'
  pull_request:
    types: [labeled]  # Trigger when a label is added to the PR
  workflow_dispatch:
    inputs:
      query:
        description: 'Custom SQL query (single query mode - backward compatible)'
        required: false
        type: string
      queries:
        description: 'Query names from benchmark-queries.json (comma-separated or "all" for multi-query mode)'
        required: false
        default: ''
        type: string

concurrency:
  group: benchmarks-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: false

permissions:
  contents: write       # Required to push benchmark results to gh-pages branch
  pull-requests: write  # Required to post comparison comments on PRs

jobs:
  setup:
    name: Determine Benchmark Queries
    runs-on: ubuntu-latest
    outputs:
      queries_json: ${{ steps.set-queries.outputs.queries_json }}
      is_multi_query: ${{ steps.set-queries.outputs.is_multi_query }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine queries to run
        id: set-queries
        run: |
          QUERIES_INPUT="${{ github.event.inputs.queries }}"
          QUERY_INPUT="${{ github.event.inputs.query }}"
          IS_MULTI_QUERY="false"
          HAS_BENCHMARK_LABEL="${{ contains(github.event.pull_request.labels.*.name, 'benchmark') }}"

          if [ -n "$QUERIES_INPUT" ]; then
            # Multi-query mode via workflow_dispatch with queries input
            echo "Multi-query mode detected - queries input: $QUERIES_INPUT"
            if [ "$QUERIES_INPUT" = "all" ]; then
              QUERIES=$(jq -c '.' csharp/Benchmarks/benchmark-queries.json)
            else
              # Filter specific queries by name
              IFS=',' read -ra QUERY_NAMES <<< "$QUERIES_INPUT"
              FILTER=$(printf '"%s",' "${QUERY_NAMES[@]}")
              FILTER="[${FILTER%,}]"
              QUERIES=$(jq -c --argjson names "$FILTER" '[.[] | select(.name as $n | $names | index($n))]' csharp/Benchmarks/benchmark-queries.json)
            fi
            IS_MULTI_QUERY="true"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Multi-query mode on push to main
            echo "Multi-query mode detected - push to main"
            QUERIES=$(jq -c '.' csharp/Benchmarks/benchmark-queries.json)
            IS_MULTI_QUERY="true"
          elif [ "$HAS_BENCHMARK_LABEL" = "true" ] && [ "${{ github.event_name }}" = "pull_request" ]; then
            # Multi-query mode via PR benchmark label
            echo "Multi-query mode detected - benchmark label on PR"
            QUERIES=$(jq -c '.' csharp/Benchmarks/benchmark-queries.json)
            IS_MULTI_QUERY="true"
          else
            # Single-query mode (manual workflow_dispatch with custom query)
            echo "Single-query mode detected"
            if [ -n "$QUERY_INPUT" ]; then
              QUERY="$QUERY_INPUT"
            else
              QUERY="select * from main.tpcds_sf1_delta.catalog_sales"
            fi
            QUERIES=$(jq -n --arg q "$QUERY" '[{
              "name": "default",
              "description": "Custom or default query",
              "query": $q,
              "category": "custom"
            }]')
          fi

          echo "is_multi_query=$IS_MULTI_QUERY" >> $GITHUB_OUTPUT
          echo "queries_json=$QUERIES" >> $GITHUB_OUTPUT
          echo "Benchmark queries configuration:"
          echo "$QUERIES" | jq '.'
          echo "Multi-query mode: $IS_MULTI_QUERY"
          echo "Query count: $(echo "$QUERIES" | jq 'length')"

  benchmark-net8:
    name: Benchmark Suite (.NET 8.0)
    needs: setup
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'benchmark'))
    runs-on: ubuntu-latest
    timeout-minutes: 180
    environment: azure-prod
    env:
      DATABRICKS_SERVER_HOSTNAME: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_HTTP_PATH: ${{ secrets.TEST_PECO_WAREHOUSE_HTTP_PATH }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_TEST_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_TEST_CLIENT_SECRET }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build
        shell: bash
        run: |
          ./ci/scripts/csharp_build.sh "${{ github.workspace }}"

      - name: Run benchmark suite
        shell: bash
        run: |
          mkdir -p ~/.databricks
          mkdir -p benchmark-results

          # Create config file with connection details (query will be read from benchmark-queries.json)
          cat > ~/.databricks/connection.json << EOF
          {
            "uri": "https://${{ env.DATABRICKS_SERVER_HOSTNAME }}${{ env.DATABRICKS_HTTP_PATH }}",
            "auth_type": "oauth",
            "grant_type": "client_credentials",
            "client_id": "${{ env.DATABRICKS_CLIENT_ID }}",
            "client_secret": "${{ env.DATABRICKS_CLIENT_SECRET }}",
            "type": "databricks",
            "catalog": "main",
            "db_schema": "ADBC_Testing",
            "query": "select 1"
          }
          EOF

          export DATABRICKS_TEST_CONFIG_FILE="$HOME/.databricks/connection.json"
          export DATABRICKS_BENCHMARK_QUERIES_FILE="${{ github.workspace }}/csharp/Benchmarks/benchmark-queries.json"

          QUERY_COUNT=$(jq 'length' "$DATABRICKS_BENCHMARK_QUERIES_FILE")
          echo "=== Running benchmark suite with $QUERY_COUNT queries ==="
          echo "Queries will be executed by BenchmarkDotNet in a single session"

          # Run benchmark once - BenchmarkDotNet will run all queries via ArgumentsSource
          if ./ci/scripts/csharp_benchmark.sh "${{ github.workspace }}" "net8.0"; then
            echo "âœ… Benchmark suite completed successfully"

            # Save all results
            if [ -d "csharp/Benchmarks/BenchmarkDotNet.Artifacts/results" ]; then
              cp -r csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/* benchmark-results/
            fi
          else
            echo "âŒ Benchmark suite failed"
            exit 1
          fi

      - name: Upload all benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-net8
          path: benchmark-results/
          retention-days: 90

      - name: Generate summary
        if: needs.setup.outputs.is_multi_query == 'true'
        run: |
          echo "# Benchmark Suite Results (.NET 8.0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All queries executed in a single BenchmarkDotNet session to avoid redundant builds." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "benchmark-results"/*-report-full-compressed.json ]; then
            echo "âœ… Benchmark suite completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Results include all $(jq 'length' csharp/Benchmarks/benchmark-queries.json) queries from benchmark-queries.json" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Benchmark suite failed" >> $GITHUB_STEP_SUMMARY
          fi

  benchmark-net472:
    name: Benchmark Suite (.NET Framework 4.7.2)
    needs: setup
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'benchmark'))
    runs-on: windows-2022
    timeout-minutes: 180
    environment: azure-prod
    env:
      DATABRICKS_SERVER_HOSTNAME: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_HTTP_PATH: ${{ secrets.TEST_PECO_WAREHOUSE_HTTP_PATH }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_TEST_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_TEST_CLIENT_SECRET }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build
        shell: bash
        run: |
          ./ci/scripts/csharp_build.sh "${{ github.workspace }}"

      - name: Run benchmark suite
        shell: pwsh
        run: |
          $configDir = Join-Path $env:USERPROFILE ".databricks"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null
          New-Item -ItemType Directory -Force -Path "benchmark-results" | Out-Null

          # Create config file with connection details (query will be read from benchmark-queries.json)
          $config = @{
            uri = "https://${{ env.DATABRICKS_SERVER_HOSTNAME }}${{ env.DATABRICKS_HTTP_PATH }}"
            auth_type = "oauth"
            grant_type = "client_credentials"
            client_id = "${{ env.DATABRICKS_CLIENT_ID }}"
            client_secret = "${{ env.DATABRICKS_CLIENT_SECRET }}"
            type = "databricks"
            catalog = "main"
            db_schema = "ADBC_Testing"
            query = "select 1"
          } | ConvertTo-Json

          $configPath = Join-Path $configDir "connection.json"
          $config | Out-File -FilePath $configPath -Encoding utf8
          $env:DATABRICKS_TEST_CONFIG_FILE = $configPath

          $queriesFile = Join-Path "${{ github.workspace }}" "csharp/Benchmarks/benchmark-queries.json"
          $env:DATABRICKS_BENCHMARK_QUERIES_FILE = $queriesFile

          $queryCount = (Get-Content $queriesFile | ConvertFrom-Json).Count
          Write-Host "=== Running benchmark suite with $queryCount queries ==="
          Write-Host "Queries will be executed by BenchmarkDotNet in a single session"

          # Run benchmark once - BenchmarkDotNet will run all queries via ArgumentsSource
          $benchmarkPath = Join-Path "${{ github.workspace }}" "ci/scripts/csharp_benchmark.sh"
          bash $benchmarkPath "${{ github.workspace }}" "net472"

          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… Benchmark suite completed successfully"

            # Save all results
            $resultsPath = "csharp/Benchmarks/BenchmarkDotNet.Artifacts/results"
            if (Test-Path $resultsPath) {
              Copy-Item -Path "$resultsPath/*" -Destination "benchmark-results/" -Recurse -Force
            }
          } else {
            Write-Host "âŒ Benchmark suite failed"
            exit 1
          }

      - name: Upload all benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-net472
          path: benchmark-results/
          retention-days: 90

      - name: Generate summary
        if: needs.setup.outputs.is_multi_query == 'true'
        shell: bash
        run: |
          echo "# Benchmark Suite Results (.NET Framework 4.7.2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All queries executed in a single BenchmarkDotNet session to avoid redundant builds." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "benchmark-results"/*-report-full-compressed.json ]; then
            echo "âœ… Benchmark suite completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Results include all $(jq 'length' csharp/Benchmarks/benchmark-queries.json) queries from benchmark-queries.json" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Benchmark suite failed" >> $GITHUB_STEP_SUMMARY
          fi

  post-results:
    name: Post Benchmark Results to PR
    needs: [setup, benchmark-net8, benchmark-net472]
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'benchmark')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download .NET 8.0 results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results-net8
          path: results-net8

      - name: Download .NET Framework 4.7.2 results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results-net472
          path: results-net472

      - name: Download baseline results from main
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find the latest successful workflow run on main branch
          MAIN_RUN_ID=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow benchmarks.yml \
            --branch main \
            --status success \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')

          if [ -n "$MAIN_RUN_ID" ]; then
            echo "Found baseline run: $MAIN_RUN_ID"
            mkdir -p baseline-net8 baseline-net472

            # Download baseline artifacts
            gh run download $MAIN_RUN_ID \
              --repo ${{ github.repository }} \
              --name benchmark-results-net8 \
              --dir baseline-net8 || echo "No baseline for .NET 8.0"

            gh run download $MAIN_RUN_ID \
              --repo ${{ github.repository }} \
              --name benchmark-results-net472 \
              --dir baseline-net472 || echo "No baseline for .NET Framework 4.7.2"
          else
            echo "No baseline run found on main branch"
          fi

      - name: Compare and post results
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find the result files
          NET8_RESULTS=$(find results-net8 -name "*-report-full-compressed.json" | head -1)
          NET472_RESULTS=$(find results-net472 -name "*-report-full-compressed.json" | head -1)
          NET8_BASELINE=$(find baseline-net8 -name "*-report-full-compressed.json" 2>/dev/null | head -1)
          NET472_BASELINE=$(find baseline-net472 -name "*-report-full-compressed.json" 2>/dev/null | head -1)

          # Create comment body
          cat > comment.md << 'EOF'
          ## ðŸ“Š CloudFetch Benchmark Results

          EOF

          # Function to format comparison
          format_results() {
            local CURRENT=$1
            local BASELINE=$2
            local PLATFORM=$3

            if [ ! -f "$CURRENT" ]; then
              echo "âš ï¸ Results not found"
              return
            fi

            echo "| Query | Mean (ms) | Baseline | Diff | Rows | Columns |"
            echo "|-------|-----------|----------|------|------|---------|"

            # Parse current results - Parameters is a string like "ReadDelayMs=5&benchmarkQuery=catalog_sales"
            jq -r '.Benchmarks[] | "\(.Parameters)|\(.Statistics.Mean / 1000000)"' "$CURRENT" | while IFS='|' read -r params mean; do
              # Extract query name from parameters string
              query=$(echo "$params" | sed -n 's/.*benchmarkQuery=\([^&]*\).*/\1/p')

              if [ -z "$query" ]; then
                continue
              fi

              # Get rows and columns from the benchmark-queries.json if available
              rows="-"
              cols="-"
              if [ -f "csharp/Benchmarks/benchmark-queries.json" ]; then
                rows=$(jq -r --arg q "$query" '.[] | select(.name == $q) | .expected_rows // "-"' csharp/Benchmarks/benchmark-queries.json 2>/dev/null || echo "-")
                cols=$(jq -r --arg q "$query" '.[] | select(.name == $q) | .columns // "-"' csharp/Benchmarks/benchmark-queries.json 2>/dev/null || echo "-")
              fi

              # Format mean to 2 decimal places
              mean_formatted=$(printf "%.2f" "$mean")

              # Try to find baseline
              if [ -f "$BASELINE" ]; then
                baseline_mean=$(jq -r --arg q "$query" '.Benchmarks[] | select(.Parameters | contains("benchmarkQuery=" + $q)) | .Statistics.Mean / 1000000' "$BASELINE" 2>/dev/null | head -1)
                if [ -n "$baseline_mean" ] && [ "$baseline_mean" != "null" ]; then
                  baseline_formatted=$(printf "%.2f" "$baseline_mean")
                  # Calculate percentage difference
                  diff=$(echo "scale=1; (($mean - $baseline_mean) / $baseline_mean) * 100" | bc)
                  if (( $(echo "$diff > 0.5" | bc -l) )); then
                    diff_formatted="ðŸ”´ +${diff}%"
                  elif (( $(echo "$diff < -0.5" | bc -l) )); then
                    diff_formatted="ðŸŸ¢ ${diff}%"
                  else
                    diff_formatted="âšª ~0%"
                  fi
                  echo "| $query | $mean_formatted | $baseline_formatted | $diff_formatted | $rows | $cols |"
                else
                  echo "| $query | $mean_formatted | - | - | $rows | $cols |"
                fi
              else
                echo "| $query | $mean_formatted | - | - | $rows | $cols |"
              fi
            done
          }

          # .NET 8.0 results
          echo "<details open>" >> comment.md
          echo "<summary><b>.NET 8.0</b></summary>" >> comment.md
          echo "" >> comment.md
          format_results "$NET8_RESULTS" "$NET8_BASELINE" ".NET 8.0" >> comment.md
          echo "" >> comment.md
          echo "</details>" >> comment.md
          echo "" >> comment.md

          # .NET Framework 4.7.2 results
          echo "<details>" >> comment.md
          echo "<summary><b>.NET Framework 4.7.2</b></summary>" >> comment.md
          echo "" >> comment.md
          format_results "$NET472_RESULTS" "$NET472_BASELINE" ".NET Framework 4.7.2" >> comment.md
          echo "" >> comment.md
          echo "</details>" >> comment.md

          # Footer
          cat >> comment.md << 'EOF'

          ---
          *ðŸŸ¢ Improvement | ðŸ”´ Regression | âšª No change | Baseline from latest main branch run*
          EOF

          # Post comment to PR
          gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body-file comment.md
